name: Build And Run Test on Ubuntu

on:
  push:
  pull_request: 
  workflow_dispatch:

env:
  BUILD_TYPE: Release

jobs:
  Build_and_Run_PyTest:
    name: Build and Run PyTest
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash -l {0}

    steps:
    - uses: actions/checkout@v2
      with:
        submodules: recursive

    - uses: conda-incubator/setup-miniconda@v2
      with:
        miniconda-version: "latest"
        activate-environment: wic
        channels: conda-forge

    - name: Install System Dependencies from Conda
# The version of cwltool in apt (2.0.20200224214940) does not support CWL version 1.2
#      run: sudo apt install cwltool
# Use conda to install cwltool (version 3.1.20220224085855)
      working-directory: ${{github.workspace}}
      run: |
        conda info
        conda list
        conda config --show-sources
        conda config --show
        conda install cwltool
        ./conda_devtools.sh

    - name: Install System Graphviz (NOT python3-graphviz)
      run: |
        sudo DEBIAN_FRONTEND=noninteractive apt-get -y update
        sudo DEBIAN_FRONTEND=noninteractive apt-get -y install graphviz

    - name: Setup Python
      uses: actions/setup-python@v2
      with:
        python-version: "3.x"

    - name: Install Python Dependencies from pip
      run: python -m pip install --upgrade graphviz
# NOTE: This 'graphviz' refers to the python bindings to the underlying
# system binary graphviz package (i.e. the `dot` executable) which we need to 
# install separately using either `conda install graphviz` or `sudo apt install graphviz`.
# This 'graphviz' is equivalent to `conda install python-graphviz` or
# `sudo apt install python3-graphiviz` ONLY.

    - name: Install Workflow Inference Compiler
      working-directory: ${{github.workspace}}
      run: pip install ".[test]"

    - name: Run MyPy
      working-directory: ${{github.workspace}}
      # NOTE: Do not use `mypy .` because then mypy will check both src/ and build/ causing:
      # src/wic/__init__.py: error: Duplicate module named "wic" (also at "./build/lib/wic/__init__.py")
      # NOTE: We need to use --no-incremental because there is a bug in mypy.
      # This bug most often occurs when using ruamel library.
      # See https://github.com/python/mypy/issues/12664
      run: mypy --no-incremental src/ tests/

    - name: Run PyLint
      working-directory: ${{github.workspace}}
      # NOTE: See fail-under threshold in .pylintrc
      run: pylint src/ tests/

    - name: Run PyTest Serial Tests
      working-directory: ${{github.workspace}}
      run: pytest --cov -m serial --cov-config=.coveragerc_serial

    - name: Run PyTest Unit Tests
      working-directory: ${{github.workspace}}
      run: pytest --cov -k test_units.py --workers 4 --cov-config=.coveragerc_unit

    - name: Run PyTest Examples Tests
      working-directory: ${{github.workspace}}
      run: pytest --cov -k test_examples.py --workers 4 --cov-config=.coveragerc_parallel
